{% extends "base.html" %}

{% block title %}CURHUB | Chi tiết CTĐT{% endblock %}

{% block page_title %}Chi tiết Chương trình Đào tạo{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'daotao:danh_sach_ctdt' %}">Quản lý CTĐT</a></li>
    <li class="breadcrumb-item active">Chi tiết CTĐT</li>
{% endblock %}

{% block content %}
<div class="card card-primary card-outline">
    <div class="card-header">
        <h3 class="card-title">{{ ctdt.ten_nganh_ctdt }}</h3>
        <div class="card-tools">
            <span class="badge
                {% if ctdt.trang_thai == 'APPROVED' %} badge-success
                {% elif ctdt.trang_thai == 'PENDING_APPROVAL' %} badge-warning
                {% elif ctdt.trang_thai == 'DRAFT' %} badge-secondary
                {% elif ctdt.trang_thai == 'ARCHIVED' %} badge-light
                {% else %} badge-danger {% endif %}">
                <i class="fas
                    {% if ctdt.trang_thai == 'APPROVED' %} fa-check-circle
                    {% elif ctdt.trang_thai == 'PENDING_APPROVAL' %} fa-hourglass-half
                    {% elif ctdt.trang_thai == 'DRAFT' %} fa-pencil-alt
                    {% elif ctdt.trang_thai == 'ARCHIVED' %} fa-archive
                    {% else %} fa-times-circle {% endif %} mr-1"></i>
                {{ ctdt.get_trang_thai_display }}
            </span>
            <a href="{% url 'daotao:sua_ctdt' pk_ctdt=ctdt.pk %}" class="btn btn-warning btn-sm mr-1"><i class="fas fa-edit mr-1"></i>Cập nhật chương trình</a>
            <a href="{% url 'daotao:danh_sach_ctdt' %}" class="btn btn-tool"><i class="fas fa-arrow-left"></i></a>
        </div>
    </div>
    <div class="card-body">
        <p class="text-muted">Mã: {{ ctdt.ma_nganh_ctdt }} | Phiên bản: {{ ctdt.version }}</p>
        <!-- Khu vực hiển thị các nút hành động (dựa trên trạng thái) -->
        <!-- Đặt code các nút "Gửi duyệt", "Phê duyệt", "Tạo phiên bản mới" bạn đã tạo vào đây -->
        <hr>

        <ul class="nav nav-tabs" id="ctdtTab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="info-tab" data-toggle="tab" href="#info-tab-pane" role="tab" aria-controls="info-tab-pane" aria-selected="true">Thông tin chung</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="hocphan-tab" data-toggle="tab" href="#hocphan-tab-pane" role="tab" aria-controls="hocphan-tab-pane" aria-selected="false">Cấu trúc Học phần</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="cdr-tab" data-toggle="tab" href="#cdr-tab-pane" role="tab" aria-controls="cdr-tab-pane" aria-selected="false">Chuẩn Đầu Ra</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="po-tab" data-toggle="tab" href="#po-tab-pane" role="tab" aria-controls="po-tab-pane" aria-selected="false">Mục tiêu Đào tạo (PO)</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="history-tab" data-toggle="tab" href="#history-tab-pane" role="tab" aria-controls="history-tab-pane" aria-selected="false">Lịch sử Thay đổi</a>
            </li>
        </ul>
        
        <div class="tab-content" id="ctdtTabContent">
            <div class="tab-pane fade show active p-3" id="info-tab-pane" role="tabpanel">
                <h5>Thông tin chung về Chương trình Đào tạo</h5>
                <p><strong>Mã CTĐT:</strong> {{ ctdt.ma_nganh_ctdt }}</p>
                <p><strong>Đơn vị quản lý:</strong> {{ ctdt.don_vi_quan_ly.ten_don_vi }}</p>
                <p><strong>Trình độ:</strong> {{ ctdt.get_trinh_do_dao_tao_display }}</p>
                <p><strong>Hình thức đào tạo:</strong> {{ ctdt.get_hinh_thuc_dao_tao_display }}</p>
                <p><strong>Tổng số tín chỉ yêu cầu:</strong> {{ ctdt.so_tin_chi_yeu_cau|default:"N/A" }}</p>
                <p><strong>Thời gian đào tạo:</strong> {{ ctdt.thoi_gian_dao_tao|default:"N/A" }}</p>
                <p><strong>Đối tượng tuyển sinh:</strong> {{ ctdt.doi_tuong_tuyen_sinh|default:"N/A"|safe }}</p>
                <p><strong>Điều kiện tốt nghiệp:</strong> {{ ctdt.dieu_kien_tot_nghiep|default:"N/A"|safe }}</p>
                <p><strong>Văn bằng tốt nghiệp:</strong> {{ ctdt.get_van_bang_tot_nghiep_display|default:"N/A" }}</p>
                <p><strong>Chương trình tham khảo:</strong> {{ ctdt.chuong_trinh_tham_khao|default:"N/A"|safe }}</p>
                <p><strong>Mô tả chung:</strong> {{ ctdt.mo_ta_chung|default:"N/A"|safe }}</p>
                <p><strong>Ngày tạo:</strong> {{ ctdt.ngay_tao|date:"H:i:s d/m/Y" }}</p>
                <p><strong>Ngày cập nhật:</strong> {{ ctdt.ngay_cap_nhat|date:"H:i:s d/m/Y" }}</p>
                <p><strong>Phiên bản gốc:</strong>
                    {% if ctdt.phien_ban_goc %}
                        <a href="{% url 'daotao:chi_tiet_ctdt' pk_ctdt=ctdt.phien_ban_goc.pk %}">{{ ctdt.phien_ban_goc.ten_nganh_ctdt }} (v{{ ctdt.phien_ban_goc.version }})</a>
                    {% else %}
                        N/A
                    {% endif %}
                </p>
                <p><strong>Lý do thay đổi phiên bản:</strong> {{ ctdt.ly_do_thay_doi|default:"N/A"|linebreaksbr }}</p>
            </div>
            <div class="tab-pane fade p-3" id="hocphan-tab-pane" role="tabpanel">
                <div class="mb-3 text-right">
                    <a href="{% url 'daotao:them_hoc_phan_hang_loat' pk_ctdt=ctdt.pk %}" class="btn btn-success btn-sm mr-2">
                        <i class="fas fa-plus-circle mr-1"></i> Thêm Học phần hàng loạt
                    </a>
                    <a href="{% url 'daotao:upload_hoc_phan_ctdt' pk_ctdt=ctdt.pk %}" class="btn btn-info btn-sm">
                        <i class="fas fa-upload mr-1"></i> Tải lên danh sách Học phần (Excel/CSV)
                    </a>
                </div>
                <h5>Danh sách học phần trong chương trình</h5>
                <div class="table-responsive">
                    {% if hoc_phan_trong_ctdt %}
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>Mã HP</th>
                                <th>Tên Học Phần</th>
                                <th>Học kỳ DK</th>
                                <th>TC LT</th>
                                <th>TC TH</th>
                                <th>Giờ LT</th>
                                <th>Giờ TH</th>
                                <th>Giờ Tự học</th>
                                <th>Tiết LT Online</th>
                                <th>Tổng TC (Áp dụng)</th>
                                <th>Bắt buộc?</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for hp_ctdt in hoc_phan_trong_ctdt %}
                            <tr>
                                <td>{{ hp_ctdt.hoc_phan.ma_hoc_phan }}</td>
                                <td>{{ hp_ctdt.hoc_phan.ten_hoc_phan }}</td>
                                <td>{{ hp_ctdt.hoc_ky_du_kien|default:"-" }}</td>
                                <td>{{ hp_ctdt.tin_chi_ly_thuyet_apdung|default:"-" }}</td>
                                <td>{{ hp_ctdt.tin_chi_thuc_hanh_apdung|default:"-" }}</td>
                                <td>{{ hp_ctdt.so_gio_ly_thuyet_apdung|default:"-" }}</td>
                                <td>{{ hp_ctdt.so_gio_thuc_hanh_apdung|default:"-" }}</td>
                                <td>{{ hp_ctdt.so_gio_tu_hoc_apdung|default:"-" }}</td>
                                <td>{{ hp_ctdt.so_tiet_ly_thuyet_online|default:"-" }}</td>
                                <td>{{ hp_ctdt.tong_so_tin_chi_apdung }}</td>
                                <td>{% if hp_ctdt.la_bat_buoc %}Có{% else %}Không{% endif %}</td>
                                <td>
                                    <a href="{% url 'daotao:chi_tiet_hoc_phan_trong_ctdt' pk_chi_tiet_hp=hp_ctdt.pk %}" class="btn btn-info btn-sm">Xem</a>
                                    <a href="{% url 'daotao:sua_chi_tiet_hp_trong_ctdt' pk_chi_tiet_hp=hp_ctdt.pk %}" class="btn btn-warning btn-sm">Sửa</a>
                                    <a href="{% url 'daotao:xoa_chi_tiet_hp_trong_ctdt' pk_chi_tiet_hp=hp_ctdt.pk %}" class="btn btn-danger btn-sm">Xóa</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-muted">Chưa có học phần nào được liên kết với chương trình này.</p>
                    {% endif %}
                </div>
            </div>
            <div class="tab-pane fade p-3" id="cdr-tab-pane" role="tabpanel">
                <div class="mb-3 text-right">
                    <a href="{% url 'daotao:them_chuan_dau_ra' pk_ctdt=ctdt.pk %}" class="btn btn-success btn-sm">
                        <i class="fas fa-plus-circle mr-1"></i> Thêm mới Chuẩn đầu ra
                    </a>
                </div>
                <h5>Danh sách chuẩn đầu ra (PLO)</h5>
                <div class="table-responsive">
                    {% if chuan_dau_ra_ctdt %}
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>Mã CĐR</th>
                                <th>Mô tả</th>
                                <th>Loại CĐR</th>
                                <th>Mức độ</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cdr in chuan_dau_ra_ctdt %}
                            <tr>
                                <td>{{ cdr.ma_chuan_dau_ra }}</td>
                                <td>{{ cdr.noi_dung }}</td>
                                <td>{{ cdr.get_loai_cdr_display|default:"-" }}</td>
                                <td>{{ cdr.muc_do_dap_ung|default:"-" }}</td>
                                <td>
                                    <a href="{% url 'daotao:sua_chuan_dau_ra' pk_cdr=cdr.pk %}" class="btn btn-warning btn-sm">Sửa</a>
                                    <a href="{% url 'daotao:xoa_chuan_dau_ra' pk_cdr=cdr.pk %}" class="btn btn-danger btn-sm">Xóa</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-muted">Chưa có chuẩn đầu ra nào được định nghĩa cho chương trình này.</p>
                    {% endif %}
                </div>
            </div>
            <div class="tab-pane fade p-3" id="po-tab-pane" role="tabpanel">
                <div class="mb-3 text-right">
                    <a href="{% url 'daotao:them_muc_tieu_dao_tao' pk_ctdt=ctdt.pk %}" class="btn btn-success btn-sm">
                        <i class="fas fa-plus-circle mr-1"></i> Thêm mới Mục tiêu Đào tạo
                    </a>
                </div>
                <h5>Danh sách Mục tiêu Đào tạo (PO)</h5>
                <div class="table-responsive">
                    {% if muc_tieu_dao_tao_ctdt %}
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>Mã PO</th>
                                <th>Nội dung</th>
                                <th>Ngày tạo</th>
                                <th>Ngày cập nhật</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for po in muc_tieu_dao_tao_ctdt %}
                            <tr>
                                <td>{{ po.ma_muc_tieu }}</td>
                                <td>{{ po.noi_dung }}</td>
                                <td>{{ po.ngay_tao|date:"H:i:s d/m/Y" }}</td>
                                <td>{{ po.ngay_cap_nhat|date:"H:i:s d/m/Y" }}</td>
                                <td>
                                    <a href="{% url 'daotao:sua_muc_tieu_dao_tao' pk_po=po.pk %}" class="btn btn-warning btn-sm">Sửa</a>
                                    <a href="{% url 'daotao:xoa_muc_tieu_dao_tao' pk_po=po.pk %}" class="btn btn-danger btn-sm">Xóa</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-muted">Chưa có mục tiêu đào tạo nào được định nghĩa cho chương trình này.</p>
                    {% endif %}
                </div>
            </div>
            <div class="tab-pane fade p-3" id="history-tab-pane" role="tabpanel">
                <h5>Nhật ký thay đổi</h5>
                <div class="table-responsive">
                    {% if lich_su_thay_doi %}
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>Thời gian</th>
                                <th>Người thực hiện</th>
                                <th>Hành động</th>
                                <th>Chi tiết thay đổi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in lich_su_thay_doi %}
                            <tr>
                                <td>{{ log.thoi_gian|date:"H:i:s d/m/Y" }}</td>
                                <td>{{ log.nguoi_thuc_hien.username }}</td>
                                <td>{{ log.hanh_dong }}</td>
                                <td><pre>{{ log.chi_tiet_thay_doi }}</pre></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="text-muted">Chưa có lịch sử thay đổi nào cho chương trình này.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
